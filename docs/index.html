<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ariton Profile Viewer</title>
    <meta
      name="description"
      content="Ariton is a decentralized platform for building and managing communities, offering tools for communication, marketplace, and more."
    />
    <meta
      name="keywords"
      content="Ariton, communities, decentralized, superapp, blockchain, AI"
    />
    <meta name="robots" content="index, follow" />
    <link rel="icon" type="image/png" href="assets/ariton-favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <meta property="og:title" content="Ariton" />
    <meta
      property="og:description"
      content="Freedom to Connect, Power to Own"
    />
    <meta
      property="og:image"
      content="https://ariton.app/assets/ariton-social.png"
    />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="640" />
    <meta property="og:type" content="object" />
    <meta property="og:url" content="https://ariton.app" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Ariton - SuperApp for Communities" />
    <meta
      name="twitter:image"
      content="https://ariton.app/assets/ariton-social-x.png"
    />

    <style>
      :root {
        --background-color: rgb(255, 255, 255);
        --text-color: #000000;
        --logo-image: url("assets/ariton-icon-dark-stripped.svg");
        --logo-text: url("assets/ariton-text-dark.svg");
        --header-border: rgb(229, 229, 229);
        --section-background-color: rgb(245, 245, 245);
        --section-text-color: rgb(75, 85, 99);

        --button-background-color: rgb(23, 23, 23);
        --button-text-color: rgb(250, 250, 250);
      }

      [data-theme="dark"] {
        --background-color: rgb(13, 12, 12);
        --text-color: #ffffff;
        --logo-image: url("assets/ariton-icon-light-stripped.svg");
        --logo-text: url("assets/ariton-text-light.svg");
        --header-border: rgb(38, 38, 38);
        --section-background-color: rgb(23, 23, 23);
        --section-text-color: rgb(250, 250, 250);

        --button-background-color: rgb(250, 250, 250);
        --button-text-color: rgb(23, 23, 23);
      }

      html,
      body {
        width: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);

        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
        font-size: 18px;

        transition: background-color 0.4s, color 0.4s;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      button {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        font-weight: 600;
        font-style: normal;
        font-size: 18px;
      }

      a {
        color: var(--text-color);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      button {
        background-color: var(--button-background-color);
        color: var(--button-text-color);
        /* border: 2px solid var(--header-border); */
        border: 0;
        border-radius: 25px;
        padding: 16px 32px;
        cursor: pointer;
      }

      .light-button {
        color: var(--text-color);
        background-color: transparent;
      }

      .light-button:hover {
        color: var(--text-color);
        background-color: var(--header-border);
      }
    </style>

    <style>
      .hidden {
        display: none;
      }

      h2 {
        margin: 0;
        padding: 0;
        margin-bottom: 0.6em;
      }

      .profile {
        padding: 2em;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 1em;
        min-width: 200px;
      }

      .profile-info {
        border-right: 2px solid silver;
        padding-right: 1em;
        margin-right: 1em;
      }

      .profile-image {
        border-radius: 50%;
        width: 128px;
        height: 128px;
        background-color: silver;
      }

      .ellipsis {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block; /* Ensure the element is a block or inline-block */
        width: 100%; /* Ensure the element has a defined width */
      }

      .profile-bio {
        margin-top: 1em;
        margin-bottom: 0.4em;
      }

      .profile-did {
        margin-bottom: 0.4em;
      }

      .blurred {
        filter: blur(8px);
      }

      .unblurred {
        animation: fadeBlur 0.25s ease-in-out;
      }

      .profile-link {
        filter: none;
      }

      .profile-links {
        margin-top: 0.8em;
      }

      .profile-links a {
        display: block;
      }

      @keyframes fadeBlur {
        0% {
          filter: blur(8px);
        }
        100% {
          filter: blur(0px);
        }
      }

      @media only screen and (max-width: 600px) {
        .profile {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="hidden">
      <article id="template" class="profile">
        <div><img class="profile-image blurred" /></div>
        <div class="profile-details blurred">
          <h2>
            <span class="profile-name">Jane Doe</span
            ><span class="profile-title hidden">(Voluntaryist)</span>
          </h2>
          <span class="profile-did ellipsis">did:dht:8qamg...q8foy</span>
          <span class="profile-status profile-info">Online</span>
          <span class="profile-location profile-info">Earth</span>
          <div class="profile-bio">My bio is my bio...</div>
          <div class="profile-links"></div>
        </div>
        <div>
          <a class="profile-link" href=""><button>View on Ariton</button></a>
        </div>
      </article>
    </div>

    <div id="profile"></div>

    <footer>
      <p>
        <small
          >This is a profile powered by
          <a href="https://ariton.app">Ariton</a>.</small
        >
      </p>
    </footer>

    <script src="https://unpkg.com/@web5/api@0.11.0/dist/browser.js"></script>

    <script>
      function shorten(str) {
        const firstColonIndex = str.indexOf(":");
        if (firstColonIndex !== -1) {
          const secondColonIndex = str.indexOf(":", firstColonIndex + 1);
          if (secondColonIndex !== -1) {
            const prefix = str.substring(0, secondColonIndex + 1);
            str = str.substring(secondColonIndex + 1);
            return (
              prefix +
              str.substring(0, 5) +
              "..." +
              str.substring(str.length - 5)
            );
          }
        }

        return str.substring(0, 5) + "..." + str.substring(str.length - 5);
      }

      async function loadAvatar(web5, did, clonedTemplate) {
        const protocol = "https://schema.ariton.app/profile";

        const imageResponse = await web5.dwn.records.query({
          from: did,
          message: {
            filter: {
              author: did,
              protocol: protocol,
              protocolPath: "avatar",
              dataFormat: "image/jpeg",
            },
          },
        });

        if (imageResponse.records && imageResponse.records.length > 0) {
          const record = imageResponse.records[0];

          avatarRecord = record;
          let image = await record.data.text();

          clonedTemplate.querySelector(".profile-image").src = image;
 
        } else {
          console.log("No avatar found.");
        }

        clonedTemplate
            .querySelector(".profile-image")
            .classList.remove("blurred");
          clonedTemplate
            .querySelector(".profile-image")
            .classList.add("unblurred");
      }

      var initialize = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const did = urlParams.get("did");
        const protocol = "https://schema.ariton.app/profile";
        const template = document.getElementById("template");
        const parentElement = document.getElementById("profile");

        const clonedTemplate = template.cloneNode(true);
        clonedTemplate.classList.remove("hidden");

        // Append the cloned template to the parent element
        parentElement.insertBefore(clonedTemplate, parentElement.firstChild);

        initializeWeb5(clonedTemplate);
      };

      var initializeWeb5 = async function (clonedTemplate) {
        const { web5, did: userDid } = await Web5.Web5.connect();
        // console.log(web5, userDid);

        const urlParams = new URLSearchParams(window.location.search);
        const did = urlParams.get("did");
        const protocol = "https://schema.ariton.app/profile";

        const response = await web5.dwn.records.query({
          from: did,
          message: {
            filter: {
              author: did,
              protocol: protocol,
              protocolPath: "profile",
              dataFormat: "application/json",
              schema: "https://schema.ariton.app/profile/schema/profile",
            },
          },
        });

        if (response.records.length === 0) {
          console.log("no records found");
        } else {
          const record = response.records[0];
          const entry = {
            record,
            data: await record.data.json(),
          };

          console.log("records found", entry);

          clonedTemplate.querySelector(".profile-name").innerText =
            entry.data.name ?? did;

          if (entry.data.title) {
            clonedTemplate.querySelector(
              ".profile-title"
            ).innerText = `(${entry.data.title})`;
            clonedTemplate
              .querySelector(".profile-title")
              .classList.remove("hidden");
          }

          clonedTemplate.querySelector(".profile-did").innerText = shorten(did);
          clonedTemplate.querySelector(".profile-did").title = did;

          clonedTemplate.querySelector(".profile-status").innerText =
            entry.data.status ?? '';
          clonedTemplate.querySelector(".profile-location").innerText =
            entry.data.location ?? '';
          clonedTemplate.querySelector(".profile-bio").innerText =
            entry.data.bio ?? '';

          const linksContainer = clonedTemplate.querySelector(".profile-links");

          console.log('ntry.data.links.length', entry.data.links.length);

          if (entry.data.links) {
            if (entry.data.links.length > 0) {
              const strongElement = document.createElement("strong");
              strongElement.innerText = "Links";
              linksContainer.appendChild(strongElement);

              for (let i = 0; i < entry.data.links.length; i++) {
                const link = entry.data.links[i];
                const linkElement = document.createElement("a");
                linkElement.href = link;
                linkElement.innerText = link;
                linkElement.target = "_blank";
                linksContainer.appendChild(linkElement);
              }
            }
          }

          // clonedTemplate.querySelector(".profile-links").innerText =
          //   entry.data.links;

          clonedTemplate.querySelector(
            ".profile-link"
          ).href = `https://alpha.ariton.app/profile/${did}`;

          clonedTemplate
            .querySelector(".profile-details")
            .classList.remove("blurred");

          clonedTemplate
            .querySelector(".profile-details")
            .classList.add("unblurred");

          loadAvatar(web5, did, clonedTemplate);
        }
      };

      (function () {
        initialize();
      })();
    </script>
  </body>
</html>
